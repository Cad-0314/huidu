{
    "info": {
        "_postman_id": "b8f5c6a1-9d2e-4b3f-8c1a-5e6f7g8h9i0j",
        "name": "VSPAY API Collection",
        "description": "Postman collection for testing VSPAY Payin, Payout, and Utility APIs. Includes automatic signature generation.",
        "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
    },
    "event": [
        {
            "listen": "prerequest",
            "script": {
                "type": "text/javascript",
                "exec": [
                    "const secret = pm.environment.get('merchant_secret');",
                    "// 1. Resolve variables in raw body string (e.g. {{merchant_id}})",
                    "const rawBody = pm.environment.replaceIn(pm.request.body.raw);",
                    "let body;",
                    "try {",
                    "    body = JSON.parse(rawBody);",
                    "} catch (e) {",
                    "    body = {};",
                    "}",
                    "",
                    "// 2. Auto-generate IDs if needed",
                    "if (body.orderId === 'AUTO') {",
                    "    body.orderId = 'ORD-' + Date.now();",
                    "     // Update the ACTUAL request body so the server receives this ID",
                    "    pm.request.body.raw = JSON.stringify(body);",
                    "}",
                    "",
                    "// 3. Filter keys (remove empty, null, and 'sign')",
                    "const filtered = {};",
                    "Object.keys(body).forEach(k => {",
                    "    if (k !== 'sign' && body[k] !== null && body[k] !== undefined && body[k] !== '') {",
                    "        filtered[k] = body[k];",
                    "    }",
                    "});",
                    "",
                    "// 4. Sort Keys",
                    "const keys = Object.keys(filtered).sort();",
                    "",
                    "// 5. Build Query String (key=value&...)",
                    "const queryParts = keys.map(k => k + '=' + filtered[k]);",
                    "const queryString = queryParts.join('&');",
                    "",
                    "// 6. Append Secret",
                    "// Node Logic: `${queryString}&secret=${secret}`",
                    "// Even if queryString is empty, logic appends &secret=...",
                    "const signStr = queryString + '&secret=' + secret;",
                    "",
                    "// 7. Hash",
                    "const hash = CryptoJS.MD5(signStr).toString().toUpperCase();",
                    "",
                    "// 8. Set Headers",
                    "pm.request.headers.add({key: 'x-signature', value: hash});",
                    "console.log('Signature String:', signStr);",
                    "console.log('Generated Hash:', hash);"
                ]
            }
        }
    ],
    "item": [
        {
            "name": "Auth (Admin/Merchant)",
            "item": [
                {
                    "name": "Login",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "var jsonData = pm.response.json();",
                                    "if (jsonData.code === 2) {",
                                    "    pm.environment.set(\"temp_token\", jsonData.tempToken);",
                                    "    console.log(\"2FA Required. Use 'Verify 2FA' request.\");",
                                    "} else if (jsonData.code === 1) {",
                                    "    pm.environment.set(\"auth_token\", jsonData.data.token);",
                                    "    console.log(\"Login Successful\");",
                                    "}"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"username\": \"admin\",\n    \"password\": \"admin123\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/api/auth/login",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "auth",
                                "login"
                            ]
                        }
                    }
                },
                {
                    "name": "Verify 2FA",
                    "event": [
                        {
                            "listen": "test",
                            "script": {
                                "exec": [
                                    "var jsonData = pm.response.json();",
                                    "if (jsonData.code === 1) {",
                                    "    pm.environment.set(\"auth_token\", jsonData.data.token);",
                                    "    console.log(\"Token Saved\");",
                                    "}"
                                ],
                                "type": "text/javascript"
                            }
                        }
                    ],
                    "request": {
                        "method": "POST",
                        "header": [],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"tempToken\": \"{{temp_token}}\",\n    \"code\": \"111111\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/api/auth/verify-2fa",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "auth",
                                "verify-2fa"
                            ]
                        }
                    }
                }
            ]
        },
        {
            "name": "Callback Simulation",
            "item": [
                {
                    "name": "Simulate Silkpay Payin Callback",
                    "request": {
                        "method": "POST",
                        "header": [],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"mId\": \"TEST\",\n    \"mOrderId\": \"YOUR_ORDER_ID\",\n    \"payOrderId\": \"SILK_PAY_ID\",\n    \"amount\": 100,\n    \"status\": 1,\n    \"timestamp\": 1234567890,\n    \"sign\": \"GENERATED_VIA_SCRIPT_IF_NEEDED\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/api/callback/silkpay/payin",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "callback",
                                "silkpay",
                                "payin"
                            ]
                        }
                    }
                }
            ]
        },
        {
            "name": "Payin",
            "item": [
                {
                    "name": "Create Payin Order",
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "x-merchant-id",
                                "value": "{{merchant_id}}",
                                "type": "text"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"orderId\": \"AUTO\",\n    \"orderAmount\": 500,\n    \"callbackUrl\": \"https://your-callback-url.com/api/notify\",\n    \"skipUrl\": \"https://your-site.com/success\",\n    \"param\": \"test-param\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/api/payin/create",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "payin",
                                "create"
                            ]
                        }
                    },
                    "response": []
                },
                {
                    "name": "Query Payin Status",
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "x-merchant-id",
                                "value": "{{merchant_id}}",
                                "type": "text"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"orderId\": \"YOUR_ORDER_ID_HERE\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/api/payin/query",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "payin",
                                "query"
                            ]
                        }
                    },
                    "response": []
                },
                {
                    "name": "Submit UTR",
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "x-merchant-id",
                                "value": "{{merchant_id}}",
                                "type": "text"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"orderId\": \"YOUR_ORDER_ID_HERE\",\n    \"utr\": \"123456789012\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/api/payin/submit-utr",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "payin",
                                "submit-utr"
                            ]
                        }
                    },
                    "response": []
                }
            ]
        },
        {
            "name": "Payout",
            "item": [
                {
                    "name": "Bank Payout",
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "x-merchant-id",
                                "value": "{{merchant_id}}",
                                "type": "text"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"orderId\": \"AUTO\",\n    \"amount\": 100,\n    \"account\": \"1234567890\",\n    \"ifsc\": \"SBIN0001234\",\n    \"personName\": \"John Doe\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/api/payout/bank",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "payout",
                                "bank"
                            ]
                        }
                    },
                    "response": []
                },
                {
                    "name": "Query Payout",
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "x-merchant-id",
                                "value": "{{merchant_id}}",
                                "type": "text"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"orderId\": \"YOUR_PAYOUT_ID\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/api/payout/query",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "payout",
                                "query"
                            ]
                        }
                    },
                    "response": []
                }
            ]
        },
        {
            "name": "Utility",
            "item": [
                {
                    "name": "Balance Query",
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "x-merchant-id",
                                "value": "{{merchant_id}}",
                                "type": "text"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/api/balance/query",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "balance",
                                "query"
                            ]
                        }
                    },
                    "response": []
                },
                {
                    "name": "IP Whitelist (Manage)",
                    "request": {
                        "method": "POST",
                        "header": [
                            {
                                "key": "Authorization",
                                "value": "Bearer YOUR_JWT_TOKEN",
                                "type": "text"
                            }
                        ],
                        "body": {
                            "mode": "raw",
                            "raw": "{\n    \"ips\": \"1.2.3.4, 8.8.8.8\"\n}",
                            "options": {
                                "raw": {
                                    "language": "json"
                                }
                            }
                        },
                        "url": {
                            "raw": "{{base_url}}/api/merchant/ip-whitelist",
                            "host": [
                                "{{base_url}}"
                            ],
                            "path": [
                                "api",
                                "merchant",
                                "ip-whitelist"
                            ]
                        }
                    },
                    "response": []
                }
            ]
        }
    ],
    "variable": [
        {
            "key": "base_url",
            "value": "https://vspay.vip",
            "type": "string"
        },
        {
            "key": "merchant_id",
            "value": "YOUR_MERCHANT_UUID",
            "type": "string"
        },
        {
            "key": "merchant_secret",
            "value": "YOUR_MERCHANT_KEY",
            "type": "string"
        }
    ]
}