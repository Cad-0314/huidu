<!DOCTYPE html>
<html lang="en" style="--primary-color: #ed7238;">

<head>
    <style>
        body {
            transition: opacity ease-in 0.2s;
        }

        body[unresolved] {
            opacity: 0;
            display: block;
            overflow: hidden;
            position: relative;
        }
    </style>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Payment</title>
    <!-- Bootstrap CSS (Inferred from class names in user snippet) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* Custom Styles from inspiration */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f9fa;
        }

        .head {
            background-color: #ed7238;
            padding: 10px 0;
        }

        .f2pay_logo {
            height: 30px;
        }

        .order_amount {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .step_font {
            font-weight: bold;
            color: #ed7238;
            font-size: 16px;
        }

        .method-title {
            font-weight: 500;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .active_payment {
            border: 1px solid #ed7238;
            background-color: #fff5f2;
            cursor: pointer;
            transition: all 0.2s;
        }

        .active_payment:active {
            transform: scale(0.98);
        }

        .app_logo {
            width: 30px;
            height: 30px;
            border-radius: 5px;
        }

        .app_logo_phonepe {
            width: 30px;
            height: 30px;
            border-radius: 5px;
        }

        .payment_name {
            font-weight: 600;
            line-height: 30px;
        }

        .paytm-btn-wrap {
            align-items: center;
        }

        .utr_input {
            width: 100%;
            border: none;
            outline: none;
            padding: 10px;
            font-size: 16px;
        }

        .input-wrapper {
            border: 1px solid #ced4da;
            border-radius: 5px;
            overflow: hidden;
            background: #fff;
        }

        .label-tag {
            background: #eee;
            padding: 5px 10px;
            font-size: 12px;
            color: #666;
            width: 100%;
            border-bottom: 1px solid #ddd;
        }

        .scanTitle2 {
            font-size: 14px;
            color: #dc3545;
            margin-bottom: 10px;
            font-weight: bold;
        }

        #qrcode {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        #qrcode img {
            display: block;
            max-width: 100%;
            height: auto;
            margin: 0 auto;
        }

        .btn-primary {
            background-color: #ed7238;
            border-color: #ed7238;
        }

        .btn-primary:hover {
            background-color: #d65f2a;
            border-color: #d65f2a;
        }

        .btn-primary:disabled {
            background-color: #fab696;
            border-color: #fab696;
        }

        /* Spinner */
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
        }
    </style>
</head>

<body>
    <!-- Hidden Inputs -->
    <input type="hidden" id="accountInfoData" value="{{ACCOUNT_INFO}}">
    <input type="hidden" id="orderId" value="{{ORDER_ID}}">
    <input type="hidden" id="amount" value="{{AMOUNT}}">
    <input type="hidden" id="channel" value="{{CHANNEL}}">

    <div id="app" data-v-app="">
        <div id="appPage"
            style="max-width: 400px; margin: 0px auto; min-height: 100vh; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.05);">

            <div class="head">
                <nav class="navbar navbar-expand-lg">
                    <div class="container-md">
                        <a class="navbar-brand page_back" href="#"></a>
                        <div class="me-1">
                            <!-- Logo Placeholder, using text if image fails -->
                            <span style="color: white; font-weight: bold; font-size: 18px;">Payment</span>
                        </div>
                    </div>
                </nav>
            </div>

            <div class="body p-3">

                <!-- Amount and Timer -->
                <div class="my-3">
                    <div style="display: flex; align-items: center;">
                        <p class="order_amount">₹{{AMOUNT}}</p>
                        <span id="timer"
                            style="display: inline-block; margin-left: auto; text-align: right; color: rgb(245, 63, 63); font-weight: 500;">05:00</span>
                    </div>
                </div>

                <!-- Step 1: Transfer -->
                <div class="my-2">
                    <div class="step_font"> Step1 Transfer </div>
                </div>

                <!-- Payment Methods (PhonePe/Paytm Intent) -->
                <div id="intent-methods">
                    <div class="method-title">
                        <span>Use Payment App</span>
                        <span style="font-size: 20px;">一</span>
                    </div>

                    <div class="row g-2">
                        <!-- PhonePe -->
                        <div class="col-12" id="btn-phonepe" style="display: none;">
                            <div class="card py-3 active_payment">
                                <div class="d-flex ms-3 paytm-btn-wrap">
                                    <i class="fas fa-mobile-alt fa-lg text-primary me-2"></i>
                                    <span class="payment_name">PhonePe</span>
                                    <div class="ms-auto me-3 payment_name text-primary">Click To Pay</div>
                                </div>
                            </div>
                        </div>

                        <!-- Paytm -->
                        <div class="col-12" id="btn-paytm" style="display: none;">
                            <div class="card py-3 active_payment">
                                <div class="d-flex ms-3 paytm-btn-wrap">
                                    <i class="fas fa-wallet fa-lg text-info me-2"></i>
                                    <span class="payment_name">Paytm</span>
                                    <div class="ms-auto me-3 payment_name text-primary">Click To Pay</div>
                                </div>
                            </div>
                        </div>

                        <!-- Generic UPI -->
                        <div class="col-12" id="btn-upi" style="display: none;">
                            <div class="card py-3 active_payment">
                                <div class="d-flex ms-3 paytm-btn-wrap">
                                    <i class="fas fa-university fa-lg text-success me-2"></i>
                                    <span class="payment_name">UPI App</span>
                                    <div class="ms-auto me-3 payment_name text-primary">Click To Pay</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="height: 16px;"></div>
                <div style="height: 4px; background-color: #f1f2f3;"></div>

                <!-- QR Code Section -->
                <div class="method-title" style="margin-top: 16px;">
                    <span>Scan QR Code</span>
                    <span style="font-size: 20px;">一</span>
                </div>

                <div class="text-center mt-3">
                    <div class="scanTitle2">Don't use same QR code to pay multiple times</div>
                    <div id="qrcode"></div>
                    <div class="step_font_subtitle mt-1" style="color: #666; font-size: 14px;"> Scan using any UPI App
                    </div>
                </div>

                <div style="height: 16px; width: 100%; border-bottom: 2px dashed #ccc;"></div>

                <!-- Step 2: UTR Submission -->
                <div class="my-3">
                    <div class="step_font my-3"> Step 2 - Submit UTR </div>
                    <div class="mt-2">
                        <div class="input-wrapper">
                            <div class="label-tag">UTR / Reference No (12 Digits)</div>
                            <div class="input-border">
                                <input type="number" id="utrInput" placeholder="Enter 12-digit UTR" class="utr_input"
                                    maxlength="12" pattern="\d*">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 pb-1">
                    <button id="submitUtrBtn" class="btn btn-primary btn-lg" disabled>
                        <small>Submit UTR</small>
                    </button>
                </div>

                <div class="mb-5 mt-3">
                    <div class="d-flex" style="color: rgb(110, 129, 153); font-size: 13px; line-height: 1.5;">
                        <div class="me-2"><i class="fas fa-info-circle"></i></div>
                        <div>
                            1. Please ensure you enter the correct 12-digit UTR.<br>
                            2. Do not make a second payment via QR code for the same order.<br>
                            3. If payment is successful but order pending, submit UTR manually.<br>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const orderId = document.getElementById('orderId').value;
        const accountInfoJson = document.getElementById('accountInfoData').value;
        let accountInfo = null;

        try {
            accountInfo = JSON.parse(accountInfoJson);
        } catch (e) {
            console.error('Failed to parse account info', e);
        }

        // --- QR Code Generation ---
        const qrcodeElement = document.getElementById('qrcode');
        if (accountInfo && (accountInfo.upiScan || accountInfo.upi)) {
            let qrText = accountInfo.upiScan || accountInfo.upi;

            // If it looks like query params without scheme, prepending upi://pay?
            if (qrText && !qrText.startsWith('upi://') && !qrText.startsWith('http')) {
                if (qrText.startsWith('pa=') || qrText.includes('&am=')) {
                    qrText = 'upi://pay?' + qrText;
                } else if (qrText.includes('@')) {
                    // It's likely just a VPA address
                    qrText = `upi://pay?pa=${qrText}&pn=Merchant&am=${document.getElementById('amount').value}&cu=INR`;
                }
            }

            new QRCode(qrcodeElement, {
                text: qrText,
                width: 180,
                height: 180,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        } else {
            qrcodeElement.innerHTML = '<span class="text-danger">QR Code Unavailable</span>';
        }

        // --- Intent Links ---
        if (accountInfo) {
            // PhonePe
            const btnPhonePe = document.getElementById('btn-phonepe');
            if (accountInfo.upiPhonepe) {
                btnPhonePe.style.display = 'block';
                btnPhonePe.onclick = () => window.location.href = accountInfo.upiPhonepe;
            }

            // Generic / Other
            const btnUpi = document.getElementById('btn-upi');
            // If we have generic intent or just a scan string we can try to use as generic intent
            const genericUrl = accountInfo.upiIntent || accountInfo.upiScan;
            if (genericUrl) {
                btnUpi.style.display = 'block';
                btnUpi.onclick = () => window.location.href = genericUrl;
            }
        }

        // --- UTR Submission ---
        const utrInput = document.getElementById('utrInput');
        const submitBtn = document.getElementById('submitUtrBtn');

        utrInput.addEventListener('input', function () {
            if (this.value.length === 12) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        });

        submitBtn.addEventListener('click', async function () {
            const utr = utrInput.value;
            if (utr.length !== 12) return alert('Please enter valid 12 digit UTR');

            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/payin/submit-utr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: orderId, utr: utr })
                });
                const result = await response.json();

                if (result.code === 1) {
                    alert('UTR Submitted Successfully! Please wait for confirmation.');
                    window.location.reload();
                } else {
                    alert(result.msg || 'Submission failed');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<small>Submit UTR</small>';
                }
            } catch (err) {
                console.error(err);
                alert('Network error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<small>Submit UTR</small>';
            }
        });

        // --- Timer ---
        let timeLeft = 300; // 5 minutes
        const timerElem = document.getElementById('timer');
        const timerInterval = setInterval(() => {
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerElem.innerText = "Expired";
                return;
            }
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            timerElem.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            timeLeft--;
        }, 1000);

        // --- Polling for Success ---
        setInterval(async () => {
            try {
                const uuid = '{{UUID}}';
                const res = await fetch(`/api/payin/status/${uuid}`);
                const data = await res.json();
                if (data.code === 1 && data.data.status === 'success') {
                    alert('Payment Successful!');
                    window.location.href = '/payment/success'; // Or skipUrl
                }
            } catch (e) { }
        }, 5000);

    </script>
</body>

</html>